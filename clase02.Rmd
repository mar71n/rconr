---
title: "Clase 02"
output: html_document
#date: '2022-05-30'
knit: (function(inputFile, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(inputFile,
                    encoding="UTF-8",
                    output_file=file.path(dirname(inputFile), out_dir, 'clase02.html')) })
---

```{r klippy, echo=FALSE, include=TRUE}
klippy::klippy('')
```

```
Tibles, filtrar y agrupar:
dplyr, filter, arrange, select, mutate,
summarise, group_by, ungroup,
```
Una versión actualizada de este material en : [clase02](https://mar71n.github.io/rconr/clase02.html)

***

```{r, echo=TRUE,  class.source='klippy'}
library(dplyr)
library(readr)
#install.packages("readr")
library(lubridate)
```

***

### Datasets
#### Tomamos de data.buenosaires el registro de vacunaciones:
```{r, echo=TRUE,  class.source='klippy'}
# https://data.buenosaires.gob.ar/dataset/plan-de-vacunacion-covid-19
#vacunas <- read_csv("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/salud/plan-de-vacunacion-covid-19/dataset_total_vacunas.csv")
# download.file("https://cdn.buenosaires.gob.ar/datosabiertos/datasets/salud/plan-de-vacunacion-covid-19/dataset_total_vacunas.csv", "datos/dataset_total_vacunas.csv")
vacunas <- read_csv("datos/dataset_total_vacunas.csv")
```

#### Una primera mirada, según lo que esperemos, por lo general alguno de estos:
```{r, echo=TRUE,  class.source='klippy'}
spec(vacunas)

head(vacunas)

summary(vacunas)
```
##### veo que en DOSIS_3 hay NAs

#### filtro los que tienen NAs
#### con *[]*
```{r, echo=TRUE,  class.source='klippy'}
vacunas[which(is.na(vacunas$DOSIS_3)),c(-1,-8)]
```
#### o con *filter*
```{r, echo=TRUE,  class.source='klippy'}
vacunas %>% filter(is.na(vacunas$DOSIS_3)) %>% select(-FECHA_ADMINISTRACION, -ID_CARGA)
```

#### pongo cero en esos NAs 
```{r, echo=TRUE,  class.source='klippy'}
vacunas[which(is.na(vacunas$DOSIS_3)), "DOSIS_3"] <- 0

summary(vacunas)
```

#### Frecuencias
```{r, echo=TRUE,  class.source='klippy'}
table(vacunas$GENERO)

table(vacunas$GRUPO_ETARIO)
```

#### Al modo dplyr:
```{r, echo=TRUE,  class.source='klippy'}
vacunas %>% count(GENERO)

vacunas %>% count(GENERO, wt = DOSIS_1)

vacunas %>% group_by(GENERO) %>% summarise(total = n())

vacunas %>% count(VACUNA, wt = DOSIS_1)
```

***

#### Que pasa con las fechas ?
##### Para esto cargamos la libreria *lubridate*
```{r, echo=TRUE,  class.source='klippy'}
head(vacunas$FECHA_ADMINISTRACION)

max(vacunas$FECHA_ADMINISTRACION)

dmy_hms(head(vacunas$FECHA_ADMINISTRACION))

max(dmy_hms(vacunas$FECHA_ADMINISTRACION))
```

***

#### Seleccionar columnas de interes, agregar columnas
##### *select()* y *mutate()*
```{r, echo=TRUE,  class.source='klippy'}
vacunas %>% select(GENERO, GRUPO_ETARIO)

vacunas %>% select(GENERO, GRUPO_ETARIO, DOSIS_1, DOSIS_2, DOSIS_3)

vacunas %>% select(GENERO, GRUPO_ETARIO, starts_with("DOSIS"))

vacunas %>% mutate(total = (DOSIS_1 + DOSIS_2 + DOSIS_3)) %>% 
            select(FECHA_ADMINISTRACION, GENERO, GRUPO_ETARIO, total)
```

#### Filtrar y ordenar
##### *filter()* y *arange()*
```{r, echo=TRUE,  class.source='klippy'}
vacunas %>% mutate(total = (DOSIS_1 + DOSIS_2 + DOSIS_3)) %>% 
            select(FECHA_ADMINISTRACION, GENERO, GRUPO_ETARIO, total) %>%
            filter(GENERO == "F")

vacunas %>% mutate(total = (DOSIS_1 + DOSIS_2 + DOSIS_3)) %>% select(FECHA_ADMINISTRACION, GENERO, GRUPO_ETARIO, total) %>%
  filter(GRUPO_ETARIO == "51 a 60") %>%
  arrange(desc(total))

vacunas %>% mutate(total = (DOSIS_1 + DOSIS_2 + DOSIS_3)) %>% select(FECHA_ADMINISTRACION, GENERO, GRUPO_ETARIO, total) %>%
  filter(total > 1000) %>%
  arrange(GENERO, desc(GRUPO_ETARIO))

```

#### Calculamos totales agrupando por GENERO
##### *goup_by()* y *summarise()*
```{r, echo=TRUE,  class.source='klippy'}
library(ggplot2)

data1 <- vacunas %>% 
         mutate(total = (DOSIS_1 + DOSIS_2 + DOSIS_3)) %>% 
         select(FECHA_ADMINISTRACION, GENERO, GRUPO_ETARIO, total) %>%
         group_by(GENERO) %>% 
         summarise(t = sum(total, na.rm=TRUE))

data1

ggplot(data1, aes(GENERO,t, fill = GENERO)) + 
  geom_bar(stat="identity", colour = "grey") +
  geom_text(aes(label= t), vjust= -0.5, color="black", size=4)
```

***

##### *options(...)* nos permite ver y configurar opciones globales de R.
##### Entre ellas, ***scipen***, con la que podemos controlar cuando usar notación cientifica.
##### _*scipen*_: Los valores positivos sesgan hacia la notación fija y los negativos hacia la notación científica: se preferirá la notación fija a menos que sea más que dígitos scipen más anchos.
##### Por defecto es cero.
```{r, echo=TRUE,  class.source='klippy'}
# guardo el valor actual
actual <- options("scipen")
# indico que use notación fija a menos que sean mas de 10 digitos:
options(scipen=10)
```
#### Sín notación cientifica:
```{r, echo=TRUE,  class.source='klippy'}
ggplot(data1, aes(GENERO,t, fill = GENERO)) + 
  geom_bar(stat="identity", colour = "grey") +
  geom_text(aes(label= t), vjust= -0.5, color="black", size=4)

# vuelvo a poner el valor anterior.
options(scipen=actual[[1]])

```

***

#### Calculamos totales por GENERO y GRUPO_ETARIO
```{r, echo=TRUE,  class.source='klippy'}
data2 <- vacunas %>% 
         mutate(total = (DOSIS_1 + DOSIS_2 + DOSIS_3)) %>% 
         select(FECHA_ADMINISTRACION, GENERO, GRUPO_ETARIO, total) %>%
         group_by(GRUPO_ETARIO, GENERO) %>% 
         summarise(t = sum(total, na.rm=TRUE))

data2

ggplot(data2, aes(GENERO,t, fill=GRUPO_ETARIO)) + 
  geom_bar(stat="identity", colour = "grey") 

ggplot(data2, aes(GRUPO_ETARIO, t, fill=GENERO)) + 
  geom_bar(stat="identity") 
```

#### Ahora agrupo primero por GENERO y luego por GRUPO_ETARIO
##### Ver que *data2* y *data3* son iguales salvo el orden de las columnas y las filas
```{r, echo=TRUE,  class.source='klippy'}
data3 <- vacunas %>% 
         mutate(total = (DOSIS_1 + DOSIS_2 + DOSIS_3)) %>% 
         select(FECHA_ADMINISTRACION, GENERO, GRUPO_ETARIO, total) %>%
         group_by(GENERO, GRUPO_ETARIO) %>% summarise(t = sum(total, na.rm=TRUE))

data1 %>% tally()
data2 %>% tally()
data3 %>% tally()
```
#### Los gráficos con data3 ¿Son iguales a los de data2?
##### ¡ probar !

***

#### Otro paso para 'acomodar' los datos:
#### DOSIS_1, DOSIS_2, DOSIS_3, no son tres variables, son tres valores de la variable DOSIS...
#### *tidyr*, *pivot_longer()*
```{r, echo=TRUE,  class.source='klippy'}
# install.packages("tidyr")
library(tidyr)

vacunas %>% select(GRUPO_ETARIO, GENERO, DOSIS_1, DOSIS_2, DOSIS_3)

vacunas %>% 
  pivot_longer(cols = c(DOSIS_1, DOSIS_2, DOSIS_3), names_to = "DOSIS", values_to = "aplicadas") %>%
  select(FECHA_ADMINISTRACION, GENERO, GRUPO_ETARIO, DOSIS, aplicadas)

vacunas %>% pivot_longer(cols = c(DOSIS_1, DOSIS_2, DOSIS_3), names_to = "DOSIS", values_to = "aplicadas") %>%
  select(FECHA_ADMINISTRACION, GENERO, GRUPO_ETARIO, DOSIS, aplicadas) %>%
  group_by(GRUPO_ETARIO, GENERO, DOSIS) %>% summarise(t = sum(aplicadas)) %>%
  ggplot(aes(x = GENERO, y = t, fill = GRUPO_ETARIO)) +
    geom_bar(stat="identity") +
    facet_wrap(~ DOSIS)
```

***
***

#### Un poco más de *ggplot*
##### *ggplot*, *aes*, *stat*, *position*, *facet*
##### *geom_bar* por defecto solo requiere *aes(x)* y hace un count
```{r, echo=TRUE,  class.source='klippy'}
dfa <- data.frame(a = c("a","b","c","a"), b=c(2,5,2,1))
ggplot(dfa, aes(a)) + 
  geom_bar() 

# El mismo gráfico con los valores por defecto explicitados:
ggplot(dfa, aes(a)) + 
  geom_bar(stat="count") 
```

#### *geom_bar* con *stat = identity* agrupa por *x* ademas suma todos los casos
#### requiere *aes(x, y)*
```{r, echo=TRUE,  class.source='klippy'}
dfa <- data.frame(a = c("a","b","c"), b=c(3,5,2))
ggplot(dfa, aes(a, b)) + 
   geom_bar(stat="identity") 

dfa <- data.frame(a = c("a","b","c","a"), b=c(2,5,2,1))
ggplot(dfa, aes(a, b)) + 
  geom_bar(stat="identity") 
```

#### por defecto *position* es *"stack"*
```{r, echo=TRUE,  class.source='klippy'}
ggplot(data2, aes(GRUPO_ETARIO, t, fill=GENERO)) + 
  geom_bar(stat="identity", position = "stack") 
```

#### Con *position* = *"dodge"*
```{r, echo=TRUE,  class.source='klippy'}
ggplot(data2, aes(GRUPO_ETARIO, t, fill=GENERO)) + 
  geom_bar(stat="identity", position = "dodge", colour = "grey") 
# el el grafico de arriba, algunos tienen tres columnas otros dos (donde no hay casos GENERO = N)
```

#### preserve (anchos de columna)
```{r, echo=TRUE,  class.source='klippy'}
ggplot(data2, aes(GRUPO_ETARIO, t, fill=GENERO)) + 
  geom_bar(stat="identity", position = position_dodge2(preserve = "single"), colour = "grey") 

ggplot(data2, aes(GRUPO_ETARIO, t, fill=GENERO)) + 
  geom_bar(stat="identity", position = position_dodge2(preserve = "total"), colour = "grey") 
```

#### Con *position* = *"fill"*
```{r, echo=TRUE,  class.source='klippy'}
ggplot(data2, aes(GRUPO_ETARIO, t, fill=GENERO)) + 
  geom_bar(stat="identity", position = "fill", colour = "grey")
```

***
***
### Bibliografia:
#### [R para Ciencia de Datos - Cap 5](https://es.r4ds.hadley.nz/transform.html#transform)

